<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>登录</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.14/css/layui.css" rel="stylesheet">
    <style>
        .center-text {
            text-align: center;
        }

        .login_font {
            font-size: 3em;
            color: black;
            padding-bottom: 1em;
            margin: 0;
            text-align: center;
        }

        .card-filp {
            height: 10vh;
            margin: 12px;
            position: relative;
            transform-style: preserve-3d;
            transition: 1s;
        }

        .front,
        .back {
            height: 100%;
            width: 100%;
            position: absolute;
            left: 0;
            top: 0;
            backface-visibility: hidden
        }

        .back {
            transform: rotateY(180deg);
        }

        .card-filp:hover {
            transform: rotateY(180deg);
        }
    </style>

</head>
<body>
<div class="layui-container" style="height: 90vh">

    <div class="layui-row" style="height: 90vh">
        <div class="layui-col-xs12 layui-col-sm8" style="padding: 1% 1%;">
            <div class="layui-panel" style="height: 80vh">
                <div style="padding: 32px ">
                    <!--登录界面-->
                    <form class="layui-form" lay-filter="form-login">
                        <div class="demo-login-container">
                            <div class="login_font">登录/添加新账号</div>
                            <div class="layui-form-item" style="display: none" id="form-div-name">
                                <div class="layui-input-wrap">
                                    <div class="layui-input-prefix">
                                        <i class="layui-icon layui-icon-username"></i>
                                    </div>
                                    <input type="text" name="name" value="" lay-verify=""
                                           placeholder="姓 名" lay-reqtext="请填写姓名" autocomplete="off"
                                           class="layui-input" lay-affix="clear">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-wrap">
                                    <div class="layui-input-prefix">
                                        <i class="layui-icon layui-icon-tabs"></i>
                                    </div>
                                    <input type="text" name="student_id" value="" lay-verify="required|number"
                                           placeholder="学 号" lay-reqtext="请填写学号" autocomplete="off"
                                           class="layui-input" lay-affix="clear">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-wrap">
                                    <div class="layui-input-prefix">
                                        <i class="layui-icon layui-icon-password"></i>
                                    </div>
                                    <input type="password" name="password" value="" lay-verify="required"
                                           placeholder="密   码" lay-reqtext="请填写密码" autocomplete="off"
                                           class="layui-input" lay-affix="eye">
                                </div>
                            </div>
                            <div class="layui-form-item" id="form-div-comment" style="display: none">
                                <div class="layui-input-wrap">
                                    <div class="layui-input-prefix">
                                        <i class="layui-icon layui-icon-reply-fill"></i>
                                    </div>
                                    <input type="text" name="comment" value="" lay-verify=""
                                           placeholder="备 注" lay-reqtext="按需填写备注" autocomplete="off"
                                           class="layui-input" lay-affix="clear">
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <div class="layui-col-xs9 layui-col-sm9">
                                    <!--<button class="layui-btn  layui-btn-fluid" lay-submit lay-filter="demo-login">-->
                                    <button class="layui-btn  layui-btn-fluid" id="login_button">
                                        登录
                                    </button>
                                </div>

                                <div class="layui-col-xs3 layui-col-sm3">
                                    <div style="display: flex; justify-content: center; align-items: center; ">
                                        <input type="checkbox" name="save_account" title="记住密码|直接登录"
                                               lay-skin="switch" lay-filter="save_account_switch">
                                    </div>
                                </div>

                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
        <div class="layui-col-xs12 layui-col-sm4" style="padding: 1% 1%; height: 80vh">
            <div class="center-text">
                <h2>已有账号
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary"
                            onclick="refresh_student_list()">
                        <i class="layui-icon layui-icon-refresh-3"></i>
                    </button>
                </h2>

            </div>
            <div style="height: 75vh;overflow: auto" id="user_list_div">

                <div class="card-filp">
                    <div class="layui-panel front">
                        <div style="display: flex;justify-content: center; align-items: center; height: 100%;">
                            <div>
                                无历史用户，请添加 <span class="layui-badge">无效</span>
                                <p>
                                    无历史用户，请添加 <span class="layui-badge">无效</span>
                                <p>
                                    无历史用户，请添加 <span class="layui-badge">无效</span>
                            </div>
                        </div>
                    </div>

                    <div class="layui-panel back">
                        <div style="display: flex;justify-content: center; align-items: center; height: 100%;">
                            <button type="button" class="layui-btn layui-btn-normal layui-btn-radius"
                                    onclick="login('2306794234')">登录
                            </button>
                            <button type="button" class="layui-btn layui-btn-danger layui-btn-radius"
                                    onclick="delete_user('2302434345')">删除
                            </button>
                        </div>
                    </div>

                </div>


            </div>

        </div>
    </div>
</div>
<script src="//unpkg.com/layui@2.9.14/dist/layui.js"></script>
<script>
    layui.use(function () {
        var $ = layui.$;
        var form = layui.form;
        var layer = layui.layer;

        $('#login_button').on('click', function () {
            form.submit('form-login', function (data) {
                const field = data.field; // 获取表单全部字段值
                const student_id = field.student_id;
                const password = field.password;

                const login_result = pywebview.api.login(student_id, password);
                login_result.then(function (result) {
                    if (result['success']) {
                        // 登录成功
                        if (field.save_account) {
                            // 保存账号密码
                            const name = field.name
                            const comment = field.comment
                            const add_result = pywebview.api.add_account(name, student_id, password, comment)
                            add_result.then(function (result) {

                                if (result['success']) {
                                    // 添加成功
                                    layer.alert(result['info'])
                                } else {
                                    // 添加失败
                                    layer.alert(result['info'])
                                }
                            })
                        } else {
                            layer.alert('登录成功')
                        }
                        window.location.replace('/fetch.html');
                    } else {
                        // 登录失败
                        layer.alert(result['info'])
                    }
                })
                console.log(login_result)

            });
            return false;
        });
    });
</script>
<script>
    layui.use(function () {
        const form = layui.form;
        const layer = layui.layer;
        // checkbox 事件
        form.on('switch(save_account_switch)', function (data) {
            const elem = data.elem; // 获得 checkbox 原始 DOM 对象
            const name_div = document.getElementById('form-div-name');
            const comment_div = document.getElementById('form-div-comment');
            if (elem.checked) {
                name_div.style.display = 'block';
                comment_div.style.display = 'block';
                layer.msg('记住账号与密码')
            } else {
                name_div.style.display = 'none';
                comment_div.style.display = 'none';
                layer.msg('直接登录')
            }
        });
        // 通过表单提交事件，演示 checkbox 不同状态下的字段结果

    });
</script>
<script>
    window.addEventListener('pywebviewready', function () {
        console.log(' pywebview is ready')
        refresh_student_list()
    })

    function refresh_student_list() {
        const container = document.getElementById('user_list_div');
        pywebview.api.get_account_list().then(function (result) {
            // 判断账号列表是否为空
            if (result.length === 0) {
                return;
            }
            // 清除其中内容
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            let student;
            for (student of result) {
                let card = create_student_card(student);
                console.log(student)
                container.appendChild(card);
            }
        })
    }

    function create_student_card(student) {
        let valid_str = ''
        if (student.validity) {
            valid_str = '<span class="layui-badge layui-bg-blue">有效</span>';
        } else {
            valid_str = '<span class="layui-badge">无效</span>';
        }

        const card = document.createElement('div');
        card.className = 'card-filp';

        const front = document.createElement('div');
        front.className = 'layui-panel front';
        card.appendChild(front);
        front.innerHTML = `
            <div style="display: flex;justify-content: center; align-items: center; height: 100%;">
              <div>
                姓名：${student.name} ${valid_str}<p>
                学号：${student.student_id}<p>
                备注：${student.comment}<p>
              </div>
            </div>
        `;

        const back = document.createElement('div');
        back.className = 'layui-panel back';
        card.appendChild(back);

        back.innerHTML = `
                        <div style="display: flex;justify-content: center; align-items: center; height: 100%;">
                            <button type="button" class="layui-btn layui-btn-normal layui-btn-radius"
                                    onclick="login(${student.student_id})">登录
                            </button>
                            <button type="button" class="layui-btn layui-btn-danger layui-btn-radius"
                                    onclick="delete_user(${student.student_id})">删除
                            </button>
                        </div>
        `;

        return card;
    }

    function login(student_id) {
        student_id=student_id.toString()
        pywebview.api.login(student_id).then(function (result) {
            if (result['success']) {
                // 登录成功
                layer.alert('登录成功')
                window.location.replace('/lecture_list.html');
            } else {
                // 登录失败
                layer.alert(result['info'])
                refresh_student_list()
            }
        })
    }

    function delete_user(student_id) {
        student_id=student_id.toString()
        pywebview.api.delete_account(student_id).then(function (result) {
            if (result['success']) {
                // 删除成功
                layer.alert('删除成功')
                refresh_student_list()
            } else {
                // 删除失败
                layer.alert(result['info'])
            }
        })
    }
</script>

</body>
</html>