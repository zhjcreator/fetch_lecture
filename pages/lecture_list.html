<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>讲座列表</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.14/css/layui.css" rel="stylesheet">
</head>
<body>
<div class="layui-container" style="height: 90vh">
    <table class="layui-hide" id="lectures_table">
    </table>

</div>
<script src="//unpkg.com/layui@2.9.14/dist/layui.js"></script>
<script type="text/html" id="toolDemo">
    <div class="layui-clear-space">
        <a class="layui-btn layui-btn-xs" lay-event="fetch">抢讲座</a>
    </div>
</script>
<script>
    layui.use(['table', 'layer'], function () {
        var table = layui.table;
        var layer = layui.layer;

        // 已知数据渲染
        const inst = table.render({
            elem: '#lectures_table',
            totalRow: true, // 开启合计行
            cols: [[ //标题栏
                {field: 'wid', title: 'ID', sort: true, hide: true},
                {field: 'lecture_name', title: '讲座名', fixed: 'left', width: 300},
                // 预约人数
                {
                    field: 'order_num', title: '预约人数', width: 60, templet: function (d) {
                        if (d.order_capacity === d.total_capacity) {
                            return '<span class="layui-badge layui-bg-red">' + d.order_capacity + ' / ' + d.total_capacity + '</span>'
                        } else if (d.order_capacity / d.total_capacity > 0.8) {
                            return '<span class="layui-badge layui-bg-orange">' + d.order_capacity + ' / ' + d.total_capacity + '</span>'
                        } else if (d.order_capacity / d.total_capacity > 0.2) {
                            return '<span class="layui-badge layui-bg-green">' + d.order_capacity + ' / ' + d.total_capacity + '</span>'
                        } else {
                            return '<span class="layui-badge layui-bg-blue">' + d.order_capacity + ' / ' + d.total_capacity + '</span>';
                        }

                    }
                },
                {field: 'location', title: '位置', width: 150},
                {field: 'order_begin_time', title: '预约开始时间', width: 150},
                {field: 'event_begin_time', title: '讲座开始时间', width: 150},
                {field: 'order_end_time', title: '预约结束时间', sort: true},
                {field: 'event_end_time', title: '讲座结束时间', sort: true},
                {field: 'guest', title: '嘉宾', sort: true, width: 100},
                {fixed: 'right', title: '操作', width: 134, minWidth: 125, templet: '#toolDemo'}
            ]],
            data: [],
            //skin: 'line', // 表格风格
            //even: true,
            page: true, // 是否显示分页
            limits: [5, 10, 15],
            limit: 5 // 每页默认显示的数量
        });
        // 监听工具条事件
        table.on('tool(lectures_table)', function (obj) {
            var data = obj.data; // 获得当前行数据
            if (obj.event === 'fetch') {
                // 打开iframe层
                layer.open({
                    type: 2,
                    title: '抢讲座 - ' + data.lecture_name,
                    area: ['90%', '90%'], // 宽高
                    content: `fetch.html?wid=${data.wid}`, // 这里替换成实际的讲座注册页面URL，带上参数
                    success: function (layero, index, that) {
                        // 更改iframe的内容
                        pywebview.api.get_lecture_info(data.wid).then(function (result) {
                            console.log(result)
                            const iframe = layero.find('iframe');
                            lecture_info = result.data
                            var iframeDocument = iframe[0].contentDocument || iframe[0].contentWindow.document;
                            iframeDocument.getElementById("online").innerText = lecture_info['online'];
                            iframeDocument.getElementById("type").innerText = lecture_info['type'];
                            iframeDocument.getElementById("order_num").innerText = lecture_info.order_capacity + ' / ' + lecture_info.total_capacity;
                            iframeDocument.getElementById("campus").innerText = lecture_info.campus;
                            iframeDocument.getElementById("location").innerText = lecture_info['location'];
                            iframeDocument.getElementById("order_begin_time").innerText = lecture_info.order_begin_time;
                            iframeDocument.getElementById("order_end_time").innerText = lecture_info.order_end_time;
                            iframeDocument.getElementById("event_begin_time").innerText = lecture_info.event_begin_time;
                            iframeDocument.getElementById("event_end_time").innerText = lecture_info.event_end_time;
                            iframeDocument.getElementById("organizer").innerText = lecture_info.organizer;
                            iframeDocument.getElementById("guest").innerText = lecture_info.guest;

                        })

                    }
                });
            }
        });
        window.addEventListener('pywebviewready', function () {
            console.log(' pywebview is ready')
            pywebview.api.get_lecture_list().then(function (result) {
                console.log(result)
                if (result['success']) {
                    table.reload('lectures_table', {data: result['data']})
                } else {
                    alert(result['info'])
                }
            })
        })

    });
</script>
<script>
    function fetch_lecture(wid) {
        // var layer = layui.layer;
        let fetch_result=null
        pywebview.api.fetch_lecture(wid).then(function (result) {
            // layer.alert('调用抢课程序成功')
            fetch_result= result
        })
        return fetch_result
    }
</script>
</body>
</html>